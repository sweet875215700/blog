<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/17/Docker-自动化运维实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/17/Docker-自动化运维实践/" itemprop="url">Docker 自动化运维实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-17T20:06:04+08:00">
                2017-08-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#背景<br>随着项目的深入，项目变得越来越大。为了应对更加复杂的业务和提高迭代速度。所以对项目进行了一次拆分，由此产生了我们需要在同一台服务器上要部署多个项目，为了保持项目与项目之间的独立性，我们打算使用docker对项目进行隔离</p>
<p>#Docker 是什么？</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-3bc9b145fab45a68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"><br>这是Docker的logo图，直观上看是一只鲸鱼拖着好多箱子在海上游走。那么在深入的思考下，对应到我们现实生活中不就是一只货船载着许多集装箱么。现实生活中集装箱解决了什么问题？在一艘大船上，可以把货物规整的摆放起来。并且各种各样的货物被集装箱标准化了，集装箱和集装箱之间不会互相影响。那么我就不需要专门运送水果的船和专门运送化学品的船了。只要这些货物在集装箱里封装的好好的，那我就可以用一艘大船把他们都运走。</p>
<p>这也就是Docker的核心思想“集装箱思想”。</p>
<p>#Docker 能做什么？<br>1.不同的应用程序可能会有不同的应用环境，比如.net开发的网站和php开发的网站依赖的软件就不一样，如果把他们依赖的软件都安装在一个服务器上就要调试很久，而且很麻烦，还会造成一些冲突。比如IIS和Apache访问端口冲突。这个时候你就要隔离.net开发的网站和php开发的网站。常规来讲，我们可以在服务器上创建不同的虚拟机在不同的虚拟机上放置不同的应用，但是虚拟机开销比较高。docker可以实现虚拟机隔离应用环境的功能，并且开销比虚拟机小，小就意味着省钱了。</p>
<p>2.你开发软件的时候用的是Ubuntu，但是运维管理的都是centos，运维在把你的软件从开发环境转移到生产环境的时候就会遇到一些Ubuntu转centos的问题，比如：有个特殊版本的数据库，只有Ubuntu支持，centos不支持，在转移的过程当中运维就得想办法解决这样的问题。这时候要是有docker你就可以把开发环境直接封装转移给运维，运维直接部署你给他的docker就可以了。而且部署速度快。</p>
<p>3.在服务器负载方面，如果你单独开一个虚拟机，那么虚拟机会占用空闲内存的，docker部署的话，这些内存就会利用起来。</p>
<p>#Docker vs 虚拟机<br>上文中我们多次提到了虚拟机,相信大家对虚拟机也有一定的了解，也有的人这样说:<em>“在一个机器上运行成百上千个虚拟机不可能，但运行成百上千个容器已经实现”</em>。那么，虚拟机和Docker的不同点是什么呢？</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-14ef9dfb00ca2eea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"><br>比较两图的差异，左图虚拟机的Guest OS层和Hypervisor层在docker中被Docker Engine层所替代。虚拟机的Guest OS即为虚拟机安装的操作系统，它是一个完整操作系统内核；虚拟机的Hypervisor层可以简单理解为一个硬件虚拟化平台，它在Host OS是以内核态的驱动存在的。</p>
<p>虚拟机实现资源隔离的方法是利用独立的OS，并利用Hypervisor虚拟化CPU、内存、IO设备等实现的。例如，为了虚拟CPU，Hypervisor会为每个虚拟的CPU创建一个数据结构，模拟CPU的全部寄存器的值，在适当的时候跟踪并修改这些值。需要指出的是在大多数情况下，虚拟机软件代码是直接跑在硬件上的，而不需要Hypervisor介入。只有在一些权限高的请求下，Guest OS需要运行内核态修改CPU的寄存器数据，Hypervisor会介入，修改并维护虚拟的CPU状态。</p>
<p>对比虚拟机实现资源和环境隔离的方案，docker就显得简练很多。docker Engine可以简单看成对Linux的NameSpace、Cgroup、镜像管理文件系统操作的封装。docker并没有和虚拟机一样利用一个完全独立的Guest OS实现环境隔离，它利用的是目前Linux内核本身支持的容器方式实现资源和环境隔离。简单的说，docker利用namespace实现系统环境的隔离；利用Cgroup实现资源限制；利用镜像实现根目录环境的隔离。</p>
<p>#Docker 实践</p>
<p>我们一我们拆分出来的搜索服务为例，来让读者更加了解Docker的使用</p>
<p>###1、Docker 安装<br>读者可以阅读官方的安装文档，但是笔者认为这些操作有些繁琐，读者可以使用如下命令进行安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/internet | sh -</div></pre></td></tr></table></figure></p>
<p>验证下是否安装成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker -v</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-e59e15b497e27234.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>###2、Docker 相关概念</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-5d8c1e1ef488d3a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>1、Docker daemon 接受并处理Docker Client发送的请求，它是运行在宿主机上的系统进程</p>
<p>2、Docker client Docker的用户接口，用户通过执行 docker 命令操作 daemon</p>
<p>3、Docker镜像是一个只读的模板。举个例子，一个镜像可以包含一个运行在Apache上的Web应用和其使用的Ubuntu操作系统。</p>
<p>4、Docker仓库用来保存镜像。可以理解为代码控制中的代码仓库。</p>
<p>5、Docker容器和文件夹很类似。一个Docker容器包含了所有的某个应用运行所需要的环境。每一个Docker容器都是从Docker镜像创建的</p>
<p>###3、创建Dockerfile<br>我们先创建一个带有java环境的干净的系统，让它作为我们的base 镜像，之后我们镜像都去继承这个base镜像</p>
<p>base Dockerfile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># MAINTAINER        shiwei &lt;shiwei@fitcare.me&gt;</div><div class="line"># DOCKER-VERSION    17.03.0-ce</div><div class="line">#</div><div class="line"># Dockerizing ubuntu: Dockerfile for building ubuntu images</div><div class="line">#</div><div class="line"></div><div class="line">FROM ubuntu:latest</div><div class="line">MAINTAINER shiwei</div><div class="line">ENV TZ &quot;Asia/Shanghai&quot;</div><div class="line">ENV TERM xterm</div><div class="line"></div><div class="line">ADD sources.list /etc/apt/sources.list</div><div class="line"></div><div class="line"># Install.</div><div class="line">RUN \</div><div class="line">  apt-get update &amp;&amp; \</div><div class="line">  apt-get -y upgrade &amp;&amp; \</div><div class="line">  apt-get install -y build-essential &amp;&amp; \</div><div class="line">  apt-get install -y software-properties-common &amp;&amp; \</div><div class="line">  apt-get install -y byobu curl git htop  unzip vim wget &amp;&amp; \</div><div class="line">  rm -rf /var/lib/apt/lists/*</div><div class="line"></div><div class="line"># java file</div><div class="line">RUN mkdir /home/software/</div><div class="line">COPY jdk-7u80-linux-x64.tar.gz /home/software/</div><div class="line"></div><div class="line"></div><div class="line">WORKDIR /home/software/</div><div class="line">RUN tar -zxf jdk-7u80-linux-x64.tar.gz</div><div class="line"></div><div class="line">#加密解密包</div><div class="line">COPY local_policy.jar /home/software/jdk1.7.0_80/jre/lib/security/</div><div class="line">COPY US_export_policy.jar /home/software/jdk1.7.0_80/jre/lib/security/</div><div class="line"></div><div class="line">#WORKDIR /home/software/jdk1.7.0_80/</div><div class="line"></div><div class="line">RUN update-alternatives --install /usr/bin/javac javac /home/software/jdk1.7.0_80/bin/javac 100</div><div class="line">RUN update-alternatives --install /usr/bin/java java /home/software/jdk1.7.0_80/bin/java 100</div><div class="line">RUN update-alternatives --display java</div><div class="line">RUN java -version</div><div class="line">RUN rm -rf jdk-7u80-linux-x64.tar.gz</div><div class="line"></div><div class="line"># expose port</div><div class="line">EXPOSE 22</div><div class="line"></div><div class="line"># Define default command.</div><div class="line">CMD [&quot;bash&quot;]</div></pre></td></tr></table></figure></p>
<p>搜索项目的镜像<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># MAINTAINER        shiwei &lt;shiwei@fitcare.me&gt;</div><div class="line"># DOCKER-VERSION    17.03.0-ce</div><div class="line">#</div><div class="line"># Dockerizing ubuntu: Dockerfile for building resin images</div><div class="line">#</div><div class="line"></div><div class="line">FROM base:latest</div><div class="line">MAINTAINER shiwei</div><div class="line"></div><div class="line">#create dir</div><div class="line">RUN mkdir /home/app/log -p</div><div class="line">RUN mkdir /home/app/workspace/searchit -p</div><div class="line"></div><div class="line">#resin</div><div class="line">COPY resin-4.0.40.tar.gz /home/software/</div><div class="line">WORKDIR /home/software/</div><div class="line">RUN tar -zxf resin-4.0.40.tar.gz</div><div class="line">RUN rm -rf resin-4.0.40.tar.gz</div><div class="line">COPY resin.xml /home/software/resin-4.0.40/conf/</div><div class="line"></div><div class="line">#测试</div><div class="line">COPY index.html /home/app/workspace/searchit</div><div class="line"></div><div class="line"># expose port</div><div class="line">EXPOSE 8080</div><div class="line"></div><div class="line">CMD [&quot;/home/software/resin-4.0.40/bin/resin.sh&quot;, &quot;console&quot;]</div></pre></td></tr></table></figure></p>
<p>去文件所在目录执行下如下命令，就可以产生镜像了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker build -t searchit .</div></pre></td></tr></table></figure>
<p>然后运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">docker run </div><div class="line">--name gym</div><div class="line"> -p 8888:8080 -d </div><div class="line"> -v /home/gym:/home/app/workspace/gym </div><div class="line">--add-host hbbusiness_db_r.hotbody.com:121.42.xx.xx </div><div class="line">--add-host hbbusiness_db_w.hotbody.com:121.42.xx.xx </div><div class="line">--add-host hbbusiness_koubei.hotbody.com:121.42.xx.xx </div><div class="line">--add-host hbbusiness_db_r_f_s.hotbody.com:121.42.xx.xx </div><div class="line">searchit:latest</div></pre></td></tr></table></figure></p>
<p>但是目前还没有达到我们对资源隔离的目的。那么我们如何对内存和CPU进行隔离呢？</p>
<p>####1、Docker 资源隔离之CUP####<br>docker 的cpu 控制 整体上来说，都是docker 自带的，而按功能来分的话 ，可以分为：</p>
<p><em>共享</em>：–cpu-shares， 通过设置对应的权重参数来控制CPU的分配，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">例如 A --cpu-shares 1024  B --cpu-shares 512</div></pre></td></tr></table></figure></p>
<p> 那么如果都跑满 A 将占有2/3 cpu时间 ，B是 1/3 ,但是 当A不使用时 ，B是能用使用全部的 CPU 资源的</p>
<p><em>独占</em>：–cpuset-cpus 可以设置容器执行在具体 的 某个或者某几个核上。core 编号 从0 开始</p>
<p>####2、Docker 资源隔离之内存####<br>设置内存 -m, –memory 如果只 设置这个参数的话， 当容器中程序使用内存超过这个值，则程序死，但是容器不会死</p>
<p>限制内存 –memory-swap ：如果使用内存超过 设置的值 ，则容器也会被kill</p>
<p>#Jenkins 自动化#<br>笔者上文陈述这么长的篇幅，但是目前和自动化还未沾边。Docker 并不会帮我们做自动化的部分工作，所以我们需要Jenkins</p>
<p>Jenkins是一个开源软件项目，旨在提供一个开放易用的软件平台，使软件的持续集成变成可能。</p>
<p>首先Jenkins并不是必不可少的，使用它笔者主要从以下几个方面考虑：</p>
<p>1、去除手工操作，这意味着部署项目不需要再登录到服务器了，减少服务器上的操作就提高了安全性，手残执行 rm -rf * 的也是比比皆是，都是血的教训<br>2、提高测试效率 。部署速度快，提交效率<br>3、上线不一定由开发或运维人员完成。<br>4、完善的历史记录和回退功能</p>
<p>由于本文并不是详细介绍jenkins 的文章，所以不会讲解jenkins如何配置，如果需要请google，只贴出核心脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker stop searchit</div><div class="line">docker start searchit</div></pre></td></tr></table></figure></p>
<p>#存在的问题<br>1、目前这个方案并没有完全实现自动化，如果有一台新的机器，我们需要为其产生镜像，或者执行Dockerfile 或者从我们的私服拉取镜像<br>2、还未有一个分布式的监控方案<br>3、分布式的Docker管理<br>4、日志处理</p>
<p>最后给大家推荐一本书吧<br>《Docker in Action》</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/17/ElasticSearch-GeoLocation-官方文档翻译之-Geo-Point/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/17/ElasticSearch-GeoLocation-官方文档翻译之-Geo-Point/" itemprop="url">ElasticSearch GeoLocation 官方文档翻译之 Geo Point</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-17T20:03:05+08:00">
                2017-08-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#Geo Points<br>Geo-points 就是我们地球的经纬度，它能够用于计算地球两点之间的距离。</p>
<p>Geo-points 不能使用动态mapping，必须提前制定好geo_point类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">PUT /attractions</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;restaurant&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;name&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;location&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;geo_point&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>####Lat/Lon Formats</p>
<p>假设我们把 location 字段定义为geo_point 类型，我们创建文档的时候应该包含一对 latitude/longitude ，可以是 string ，arrays 或者 objects<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">PUT /attractions/restaurant/1</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;:     &quot;Chipotle Mexican Grill&quot;,</div><div class="line">  &quot;location&quot;: &quot;40.715, -74.011&quot; </div><div class="line">&#125;</div><div class="line"></div><div class="line">PUT /attractions/restaurant/2</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;:     &quot;Pala Pizza&quot;,</div><div class="line">  &quot;location&quot;: &#123; </div><div class="line">    &quot;lat&quot;:     40.722,</div><div class="line">    &quot;lon&quot;:    -73.989</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PUT /attractions/restaurant/3</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;:     &quot;Mini Munchies Pizza&quot;,</div><div class="line">  &quot;location&quot;: [ -73.983, 40.719 ] </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###注意：<br>latitude/longitude  在每种类型的顺序是不一样的，在字符串中是”latitude,longitude”，但是在数组中应为[longitude,latitude]，</p>
<p>以前，字符串和数组中的经纬度顺序是一致的，但是为了和GeoJSON保持一致，所以讲数组的经纬度顺序颠倒了。</p>
<p>###Filtering by Geo Point<br>四种geo-point filters 可以帮助我们去过滤数据，当我们使用geolocation时。</p>
<p>geo_bounding_box：<br>  找出落在一个指定的长方形中的geo-points<br>geo_distance：<br>找出以一个点为中心，一个指定半径范围内的geo-points<br>geo_distance_range：<br>找出以一个点为中心，设置一个最小半径和一个最大半径，在这个之间的geo-points<br>geo_polygon：<br>找出落在一个多边形范围内的geo-points，这个代价是相当昂贵的，如果你有这样的需求，建议使用 <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/geo-shapes.html" target="_blank" rel="external">geo-shapes</a></p>
<p>每种filter的计算一个点是否落到一个区域的方式有些不同，但过程都是相似的。<br>所请求的区域被转换为quad/geohash前缀标记的范围，然后去倒排索引中搜索具有相同标记的文档。</p>
<p>###建议：<br>Geo-filters 是相当耗费性能的，它适合用于在文档数量较少的时候。首先，你应该利用其它filter先过滤掉一部分数据。</p>
<p>#Geo Bounding Box Filter</p>
<p>它是到目前为止最有效率的filter，因为他的计算非常简单。你只需提供上、下、左、右四个坐标，剩下的就是他会比较longitude 是否在左右坐标内，latitude 是否在上下坐标内<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">GET /attractions/restaurant/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;filtered&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;geo_bounding_box&quot;: &#123;</div><div class="line">          &quot;location&quot;: &#123; </div><div class="line">            &quot;top_left&quot;: &#123;</div><div class="line">              &quot;lat&quot;:  40.8,</div><div class="line">              &quot;lon&quot;: -74.0</div><div class="line">            &#125;,</div><div class="line">            &quot;bottom_right&quot;: &#123;</div><div class="line">              &quot;lat&quot;:  40.7,</div><div class="line">              &quot;lon&quot;: -73.0</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>#Optimizing Bounding Boxes</p>
<p>geo_bounding_box 是不需要将所有的geo-points都加载到内存的。因为它需要做的就是检查the lat and lon 是否落到了一个指定的区域。它可以用倒排索引去做个一次过滤。</p>
<p>为了使用这种优化，我们必须指定geo_point 的映射,设置 “lat_lon”: true<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">PUT /attractions</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;restaurant&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;name&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;location&quot;: &#123;</div><div class="line">          &quot;type&quot;:    &quot;geo_point&quot;,</div><div class="line">          &quot;lat_lon&quot;: true </div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在，当你执行下面的查询时，我们会告诉elasticsearch使用lat 和lon的索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">GET /attractions/restaurant/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;filtered&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;geo_bounding_box&quot;: &#123;</div><div class="line">          &quot;type&quot;:    &quot;indexed&quot;, </div><div class="line">          &quot;location&quot;: &#123;</div><div class="line">            &quot;top_left&quot;: &#123;</div><div class="line">              &quot;lat&quot;:  40.8,</div><div class="line">              &quot;lon&quot;: -74.0</div><div class="line">            &#125;,</div><div class="line">            &quot;bottom_right&quot;: &#123;</div><div class="line">              &quot;lat&quot;:  40.7,</div><div class="line">              &quot;lon&quot;:  -73.0</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>#Geo Distance Filter</p>
<p>geo_distance 这个过滤器会画个圆，来找到在这个落在这个圆内所有的文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">GET /attractions/restaurant/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;filtered&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;geo_distance&quot;: &#123;</div><div class="line">          &quot;distance&quot;: &quot;1km&quot;, </div><div class="line">          &quot;location&quot;: &#123; </div><div class="line">            &quot;lat&quot;:  40.715,</div><div class="line">            &quot;lon&quot;: -73.988</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>geo-distance 的搜索是相当耗费性能的，为了优化，elasticsearch会首先会画一个内切于圆的正方形。然后用bounding-box filter 过滤掉一部分数据。然后在执行geo-distance filter去找到那些落在圆内的数据。</p>
<p>#Faster Geo-Distance Calculations</p>
<p>两点之间的距离可以利用一个牺牲性能来提高精度的算法去计算</p>
<p>arc：<br>最慢但是精度最高的就是arc 了，一个把地球看成一个球体，但是精度还是有限的，因为实际上地球并不是一个真正的球体<br>plane：<br>plane 算法把地球看成扁平的。它很快但是精度低。在赤道精度最高。<br>sloppy_arc：<br>这么称呼他是因为这个算法是粗滤的计算。</p>
<p>在查询的时候，你可以和下面一样，指定一个算法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">GET /attractions/restaurant/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;filtered&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;geo_distance&quot;: &#123;</div><div class="line">          &quot;distance&quot;:      &quot;1km&quot;,</div><div class="line">          &quot;distance_type&quot;: &quot;plane&quot;, </div><div class="line">          &quot;location&quot;: &#123;</div><div class="line">            &quot;lat&quot;:  40.715,</div><div class="line">            &quot;lon&quot;: -73.988</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>#geo_distance_range Filter</p>
<p>geo_distance 和 geo_distance_range 的唯一区别是，geo_distance_range是一个圆环。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">GET /attractions/restaurant/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;filtered&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;geo_distance_range&quot;: &#123;</div><div class="line">          &quot;gte&quot;:    &quot;1km&quot;, </div><div class="line">          &quot;lt&quot;:     &quot;2km&quot;, </div><div class="line">          &quot;location&quot;: &#123;</div><div class="line">            &quot;lat&quot;:  40.715,</div><div class="line">            &quot;lon&quot;: -73.988</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>#Sorting by Distance</p>
<p>查询结果是可以跟到一个点的距离排序的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">GET /attractions/restaurant/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;filtered&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;geo_bounding_box&quot;: &#123;</div><div class="line">          &quot;type&quot;:       &quot;indexed&quot;,</div><div class="line">          &quot;location&quot;: &#123;</div><div class="line">            &quot;top_left&quot;: &#123;</div><div class="line">              &quot;lat&quot;:  40.8,</div><div class="line">              &quot;lon&quot;: -74.0</div><div class="line">            &#125;,</div><div class="line">            &quot;bottom_right&quot;: &#123;</div><div class="line">              &quot;lat&quot;:  40.4,</div><div class="line">              &quot;lon&quot;: -73.0</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;sort&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;_geo_distance&quot;: &#123;</div><div class="line">        &quot;location&quot;: &#123; </div><div class="line">          &quot;lat&quot;:  40.715,</div><div class="line">          &quot;lon&quot;: -73.998</div><div class="line">        &#125;,</div><div class="line">        &quot;order&quot;:         &quot;asc&quot;,</div><div class="line">        &quot;unit&quot;:          &quot;km&quot;, </div><div class="line">        &quot;distance_type&quot;: &quot;plane&quot; </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以问问你自己，为什么要指定距离单位，排序？这不取决于我们用米、千米而产生不同的结果。真是的原因是排序的时候会返回结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">  &quot;hits&quot;: [</div><div class="line">     &#123;</div><div class="line">        &quot;_index&quot;: &quot;attractions&quot;,</div><div class="line">        &quot;_type&quot;: &quot;restaurant&quot;,</div><div class="line">        &quot;_id&quot;: &quot;2&quot;,</div><div class="line">        &quot;_score&quot;: null,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">           &quot;name&quot;: &quot;New Malaysia&quot;,</div><div class="line">           &quot;location&quot;: &#123;</div><div class="line">              &quot;lat&quot;: 40.715,</div><div class="line">              &quot;lon&quot;: -73.997</div><div class="line">           &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;sort&quot;: [</div><div class="line">           0.08425653647614346 </div><div class="line">        ]</div><div class="line">     &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/17/从一个监控项目谈Spring-Boot-的简约/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/17/从一个监控项目谈Spring-Boot-的简约/" itemprop="url">从一个监控项目谈Spring Boot 的简约</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-17T20:02:25+08:00">
                2017-08-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>###前言<br>近期刚上线一个搜索的功能，是基于elasticsearch，我们需要将mysql的数据实时同步到elasticsearch，如果同步失败，或者延迟都会造成程序无法使用。所以需要一个监控项目去监控数据，发现异常后发送邮件报警。一个简单而又可行的思路就是定时任务去查mysql和elasticsearch，然后对比数据条数是否相等。以前的思路我们会创建一个spring的项目，然后用maven管理spring各种依赖。还要去配置mybaits和elasticsearch。其实我们一个很简单的功能，却要将90%的时间花费到项目搭建和配置中去。so，no way。这时候Spring Boot出现了</p>
<p>###项目搭建<br>先从项目搭建谈起，我们需要连接mysql、elasticsearch、mongodb，所以说我们需要配置mybatis(也可以选择其他)、spring-data-elasticsearch、spring-data-mongodb。我们用spring initializr 帮我们创建项目，如图</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-073b8de1d5af196f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="Paste_Image.png"><br>选择spring initializr ，点击next</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-42b84bcbd2d51235.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="Paste_Image.png"><br>请看红框圈出的部分，首先我们创建的是一个web项目，数据库用的到的是mysql、NoSql部分用了mongodb和elasticsearch。然后一路next后查看下我们项目结构</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-a2e8cc07d5ee247c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="Paste_Image.png"><br>Spring Boot会帮我们生成一个带有main方法的类xxxApplication 和 一个测试类<br>xxxApplicationTests<br>目前为止我们已经完成了百分之80的工作量，什么？你不信？ok，打开Application.properties,增加mysql、es、mongo的连接信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">spring.datasource.url=jdbc:mysql://xxx:3306/gym</div><div class="line">spring.datasource.username=</div><div class="line">spring.datasource.password=</div><div class="line">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</div><div class="line"></div><div class="line">#mongodb config</div><div class="line">spring.data.mongodb.uri=mongodb://hotbody_mongo:Password4Hotbody@xxx/gym?replicaSet=rs</div><div class="line"></div><div class="line">#elasticsearch config</div><div class="line">spring.data.elasticsearch.cluster-name=</div><div class="line">spring.data.elasticsearch.cluster-nodes=xxx:9300</div><div class="line">spring.data.elasticsearch.local=false</div><div class="line">spring.data.elasticsearch.repositories.enabled=true</div></pre></td></tr></table></figure></p>
<p>然后运行xxxApplication的main方法</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-225eaf421e55c508.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="Paste_Image.png"><br>可以看到spring boot 帮我们内嵌了tomcat，项目启动的时候也去初始化了mysql、mongo、es的连接池，那么到目前为止，项目搭建的工作已经完成了<br>接下来回归到我们的需求上，我们需要一个定时器,那么需要这样配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@EnableScheduling</div><div class="line">@ComponentScan(&quot;com.me&quot;)</div><div class="line">@SpringBootApplication</div><div class="line">public class DemoApplication &#123;</div><div class="line"></div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		SpringApplication.run(DemoApplication.class, args);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样就开启了，定时任务，然后我们创建定时任务的类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@Component</div><div class="line">public class Task &#123;</div><div class="line">    </div><div class="line">    @Scheduled(cron = &quot;0 0 0/1 * * ?&quot;)</div><div class="line">    public void scheduler() throws Exception&#123;</div><div class="line">       </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>定时任务就配置完了，现在我们需要一个dao层，去完成对mysql、es、mongo的查询功能，先看mysql，我们只需要创建一个接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@Mapper</div><div class="line">public interface xxxMapper &#123;</div><div class="line">    @Select(&quot;select count(*) from xxx&quot;)</div><div class="line">    Long count();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>不用担心，当我们用的时候，框架会自动帮我们注入xxxMapper的实现的。<br>同理mongo：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public interface xxxMongoRepository extends MongoRepository&lt;xxx,Long&gt;&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>elasticsearch：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public interface xxxElasticSearchRepository extends ElasticsearchRepository&lt;xxx,Long&gt;&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>只需要两个空的接口。同样框架帮我们注入实现类</p>
<p>同时不要忘记在main方法开启这两项配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">@EnableAutoConfiguration</div><div class="line">@SpringBootApplication</div><div class="line">@ComponentScan(&quot;com.pampas&quot;)</div><div class="line">@EnableMongoRepositories(&quot;com.pampas.repository&quot;)</div><div class="line">@EnableElasticsearchRepositories(&quot;com.pampas.repository&quot;)</div><div class="line">@MapperScan(&quot;com.pampas.repository&quot;)</div><div class="line">@EnableScheduling</div><div class="line">public class MonitorApplication implements EmbeddedServletContainerCustomizer&#123;</div><div class="line"></div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		SpringApplication.run(MonitorApplication.class, args);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>目前就完成了所有的工作。接下来部署项目了。在服务器上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn package</div></pre></td></tr></table></figure></p>
<p>在target目录下会生成一个jar</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar xxx.jar</div></pre></td></tr></table></figure>
<p>ok! finish</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/17/linux-磁盘挂载/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/17/linux-磁盘挂载/" itemprop="url">linux 磁盘挂载</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-17T20:01:40+08:00">
                2017-08-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fdisk -l</div></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-40337ba752b8f63a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="Paste_Image.png"><br>可以看到 /dev/vdb 有128.8GB可用，但是未被挂载，首先对其进行分区<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fdisk /dev/vdb</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-1f76b68c59cea6db.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="Paste_Image.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">输入n</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-70ddc4e6b2ca141c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="Paste_Image.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">输入p</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-525e84d8d90da782.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="Paste_Image.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">输入w</div></pre></td></tr></table></figure></p>
<p>完成分区工作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fdisk -l</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-dd9a305a760f49ca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="Paste_Image.png"></p>
<p>这时候能够看到我们的分区了，接下来格式化分区<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkfs -t ext4 /dev/vdb1</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-f2c3763e52f19ef4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="Paste_Image.png"></p>
<p>在根目录下新建disk目录，然后将分区挂载到disk目录上</p>
<pre><code>mount /dev/vdb1 /disk
</code></pre><p><img src="http://upload-images.jianshu.io/upload_images/4791533-349019eefe8be6de.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="Paste_Image.png"></p>
<p>大功告成</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/17/查找占用cpu最高的线程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/17/查找占用cpu最高的线程/" itemprop="url">查找占用cpu最高的线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-17T20:00:49+08:00">
                2017-08-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一个应用占用CPU很高，除了确实是计算密集型应用之外，通常原因都是出现了死循环。<br>原文 ：<a href="http://www.blogjava.net/hankchen" target="_blank" rel="external">http://www.blogjava.net/hankchen</a><br>以我们最近出现的一个实际故障为例，介绍怎么定位和解决这类问题。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-b7181fd97d8fc4ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>根据top命令，发现PID为28555的Java进程占用CPU高达200%，出现故障。<br>通过ps aux | grep PID命令，可以进一步确定是tomcat进程出现了问题。但是，怎么定位到具体线程或者代码呢？<br><strong>首先显示线程列表:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps -mp pid -o THREAD,tid,time</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-492bb06b74470443.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>找到了耗时最高的线程28802，占用CPU时间快两个小时了！<br><strong>其次将需要的线程ID转换为16进制格式：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">printf &quot;%x\n&quot; tid</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-0f7ac127b2ca2402.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p><strong>最后打印线程的堆栈信息：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jstack pid |grep tid -A 30</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4791533-f6a1ef293984ecf5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<p>找到出现问题的代码了！<br>现在来分析下具体的代码：ShortSocketIO.readBytes(ShortSocketIO.java:106)<br>ShortSocketIO是应用封装的一个用短连接Socket通信的工具类。readBytes函数的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">public byte[] readBytes(int length) throws IOException &#123;</div><div class="line">    if ((this.socket == null) || (!this.socket.isConnected())) &#123;</div><div class="line">        throw new IOException(&quot;++++ attempting to read from closed socket&quot;);</div><div class="line">    &#125;</div><div class="line">    byte[] result = null;</div><div class="line">    ByteArrayOutputStream bos = new ByteArrayOutputStream();</div><div class="line">    if (this.recIndex &gt;= length) &#123;</div><div class="line">           bos.write(this.recBuf, 0, length);</div><div class="line">           byte[] newBuf = new byte[this.recBufSize];</div><div class="line">           if (this.recIndex &gt; length) &#123;</div><div class="line">               System.arraycopy(this.recBuf, length, newBuf, 0, this.recIndex - length);</div><div class="line">           &#125;</div><div class="line">           this.recBuf = newBuf;</div><div class="line">           this.recIndex -= length;</div><div class="line">    &#125; else &#123;</div><div class="line">           int totalread = length;</div><div class="line">           if (this.recIndex &gt; 0) &#123;</div><div class="line">                totalread -= this.recIndex;</div><div class="line">                bos.write(this.recBuf, 0, this.recIndex);</div><div class="line">                this.recBuf = new byte[this.recBufSize];</div><div class="line">                this.recIndex = 0;</div><div class="line">    &#125;</div><div class="line">    int readCount = 0;</div><div class="line">    while (totalread &gt; 0) &#123;</div><div class="line">         if ((readCount = this.in.read(this.recBuf)) &gt; 0) &#123;</div><div class="line">                if (totalread &gt; readCount) &#123;</div><div class="line">                      bos.write(this.recBuf, 0, readCount);</div><div class="line">                      this.recBuf = new byte[this.recBufSize];</div><div class="line">                      this.recIndex = 0;</div><div class="line">               &#125; else &#123;</div><div class="line">                     bos.write(this.recBuf, 0, totalread);</div><div class="line">                     byte[] newBuf = new byte[this.recBufSize];</div><div class="line">                     System.arraycopy(this.recBuf, totalread, newBuf, 0, readCount - totalread);</div><div class="line">                     this.recBuf = newBuf;</div><div class="line">                     this.recIndex = (readCount - totalread);</div><div class="line">             &#125;</div><div class="line">             totalread -= readCount;</div><div class="line">        &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>问题就出在标红的代码部分。如果this.in.read()返回的数据小于等于0时，循环就一直进行下去了。而这种情况在网络拥塞的时候是可能发生的。<br>至于具体怎么修改就看业务逻辑应该怎么对待这种特殊情况了。</p>
<p><strong>最后，总结下排查CPU故障的方法和技巧有哪些：</strong><br>1、top命令：Linux命令。可以查看实时的CPU使用情况。也可以查看最近一段时间的CPU使用情况。<br>2、PS命令：Linux命令。强大的进程状态监控命令。可以查看进程以及进程中线程的当前CPU使用情况。属于当前状态的采样数据。<br>3、jstack：Java提供的命令。可以查看某个进程的当前线程栈运行情况。根据这个命令的输出可以定位某个进程的所有线程的当前运行状态、运行代码，以及是否死锁等等。<br>4、pstack：Linux命令。可以查看某个进程的当前线程栈运行情况。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/17/ElasticSearch-Parent-Child-官方文档翻译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/17/ElasticSearch-Parent-Child-官方文档翻译/" itemprop="url">ElasticSearch Parent-Child 官方文档翻译</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-17T19:57:54+08:00">
                2017-08-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Parent-Child-RelationShip"><a href="#Parent-Child-RelationShip" class="headerlink" title="Parent-Child RelationShip"></a>Parent-Child RelationShip</h1><p> ElasticSearch 中的Parent-Child关系和nested模型是相似的， 两个都可以用于复杂的数据结构中，区别是 nested 类型的文档是把所有的实体聚合到一个文档中而Parent-Child现对于比较独立，每个实体即为一个文档<br>Parent-Child 优点<br>1、父文档更新时不用重新为子文档建立索引<br>2、子文档的增加、修改、删除是对父文档和其他子文档没有任何影响的，这非常适用于子文档非常大并且跟新频繁的场景<br>3、子文档也可以查询结果返回<br>ElasticSearch 内部维护一个map来保存Parent-Child之间的关系，正是由于这个map，所以关联查询能够做到响应速度很快，但是确实有个限制是Parent 文档和所有的Child 文档都必须保存到同一个shard中<br>ElasticSearch parent-child ID的映射是存到Doc value 中的，有足够的内存时响 应是很快的。当这个map很大的时候，还是有要有一部分存储在硬盘中的。</p>
<p>##<a href="https://www.elastic.co/guide/en/elasticsearch/guide/2.x/parent-child-mapping.html#parent-child-mapping" target="_blank" rel="external"></a>Parent-Child Mapping<br>为了建立Parent-Child 模型我们需要在创建mapping的时候指定父文档和子文档或者在子文档创建之前利用update-index API 来指定<br>例如：我们有个公司，其子公司分布在全国各地，我要分析员工和子公司的关系<br>我们使用Parent-Child 机构<br>我们需要建立employee type 和 branch type 并且指定 branch 为_parent<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">PUT /company</div><div class="line">&#123;</div><div class="line">   &quot;mappings&quot;: &#123;</div><div class="line">        &quot;branch&quot;: &#123;&#125;,</div><div class="line">         &quot;employee&quot;: &#123;</div><div class="line">             &quot;_parent&quot;: &#123;</div><div class="line">                      &quot;type&quot;: &quot;branch&quot;</div><div class="line">              &#125;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>#Indexing Parents and Children<br>创建父索引和创建其他索引并没有区别，父文档并不需要知道他们的子文档<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">POST /company/branch/_bulk</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;london&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;London Westminster&quot;, &quot;city&quot;: &quot;London&quot;, &quot;country&quot;: &quot;UK&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;liverpool&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Liverpool Central&quot;, &quot;city&quot;: &quot;Liverpool&quot;, &quot;country&quot;: &quot;UK&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;paris&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Champs Élysées&quot;, &quot;city&quot;: &quot;Paris&quot;, &quot;country&quot;: &quot;France&quot; &#125;</div></pre></td></tr></table></figure></p>
<p>创建子文档的时候你必须指出他们的父文档的id<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">PUT /company/employee/1?parent=london </div><div class="line">&#123;</div><div class="line">  &quot;name&quot;:  &quot;Alice Smith&quot;,</div><div class="line">  &quot;dob&quot;:   &quot;1970-10-24&quot;,</div><div class="line">  &quot;hobby&quot;: &quot;hiking&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>指定parent id 有两个目的：他是父文档和子文档的关联，而且他也保证了父文档和子文档会存储在同一个shard中，<br>在routing那个章节我们解释了ElasticSearch 如何利用routing的值来决定分配到shard中的，如果文档没有指定routing的值的化，那么默认为_id,公式为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shard = hash(routing) % number_of_primary_shards</div></pre></td></tr></table></figure></p>
<p>但是，如果指定了 parent id 那么routing的值就不是_id 了 而是 parent id，换句话说就是父文档和子文档是具有相同的routing的值来确保他们会分配到同一个shard中的<br>当我们用GET请求来检索子文档时，我们需要指定parent id，并且创建索引、更新索引、还有删除索引都需要指定parent id，不像搜索的请求，他会分发到所有的shard中，这些single-document请求只会发送到存储它的shard中。如果没有指定parent id 也许请求会发送到一个错误的shard中<br>当我们使用buk API 时也需要指定parent id<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">POST /company/employee/_bulk</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2, &quot;parent&quot;: &quot;london&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Mark Thomas&quot;, &quot;dob&quot;: &quot;1982-05-16&quot;, &quot;hobby&quot;: &quot;diving&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3, &quot;parent&quot;: &quot;liverpool&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Barry Smith&quot;, &quot;dob&quot;: &quot;1979-04-01&quot;, &quot;hobby&quot;: &quot;hiking&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4, &quot;parent&quot;: &quot;paris&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Adrien Grand&quot;, &quot;dob&quot;: &quot;1987-05-11&quot;, &quot;hobby&quot;: &quot;horses&quot; &#125;</div></pre></td></tr></table></figure></p>
<p>#Finding Parents by Their Children<br>has_child 和 filter 可以根据子文档的内容来查询父文档，例如我们可以用这样的语句搜索所有分公司，出生在1980年以后的员工：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET /company/branch/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;has_child&quot;: &#123;</div><div class="line">      &quot;type&quot;: &quot;employee&quot;,</div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;range&quot;: &#123;</div><div class="line">          &quot;dob&quot;: &#123;</div><div class="line">            &quot;gte&quot;: &quot;1980-01-01&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>has_child 查询会匹配到多个子文档，每个文档都会有不同的关联得分。这些得分如何减少父文档的单个得分取决于分数模型的参数。默认参数为none，即会忽略子文档的得分，并且父文档会加1.0.<br>下面的查询会同时返回london 还有 liverpool 但是london 会得到一个更好的得分，因为Alice Smith 更加匹配london<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">GET /company/branch/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;has_child&quot;: &#123;</div><div class="line">      &quot;type&quot;:       &quot;employee&quot;,</div><div class="line">      &quot;score_mode&quot;: &quot;max&quot;,</div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;match&quot;: &#123;</div><div class="line">          &quot;name&quot;: &quot;Alice Smith&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>##min_children and max_children<br>has_child 和 filter 都有min_children 和 max_children 两个参数，作用是返回那些具有子文档个数与之相匹配的父文档数据<br>下面的查询会返回具有两个员工以上的分公司<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">GET /company/branch/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;has_child&quot;: &#123;</div><div class="line">      &quot;type&quot;:         &quot;employee&quot;,</div><div class="line">      &quot;min_children&quot;: 2, </div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;match_all&quot;: &#123;&#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>#Finding Children by Their Parents<br>和nested 查询只能返回根节点数据不同的是，父文档和子文档都是相对独立的，并且可以被单独查询，has_child 查询可以根据子文档返回父文档 而 has_parent查询会根据父文档返回子文档<br>和has_child 查询很相似，下面的查询会返回那些工作在uk的员工<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GET /company/employee/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;has_parent&quot;: &#123;</div><div class="line">      &quot;type&quot;: &quot;branch&quot;, </div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;match&quot;: &#123;</div><div class="line">          &quot;country&quot;: &quot;UK&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>has_parent 查询也支持score_mode模式，但是它只有两种设置none(默认)和score，每个子文档可以只拥有一个父文档，所以就没有必要将分数分给多个子文档了，这仅仅取决于你使用none还是score模式了</p>
<p>#Children Aggregation<br>Parent-child 支持<a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-children-aggregation.html" target="_blank" rel="external">children aggregation</a> parent aggregation 是不支持的<br>下面的例子示范了我们分析了员工的兴趣<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">GET /company/branch/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot; : 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;country&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123; </div><div class="line">        &quot;field&quot;: &quot;country&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;employees&quot;: &#123;</div><div class="line">          &quot;children&quot;: &#123; </div><div class="line">            &quot;type&quot;: &quot;employee&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;aggs&quot;: &#123;</div><div class="line">            &quot;hobby&quot;: &#123;</div><div class="line">              &quot;terms&quot;: &#123; </div><div class="line">                &quot;field&quot;: &quot;hobby&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>#Grandparents and Grandchildren<br>parent-child 关系不仅仅可以有两代，他可以具有多代关系，但是所有关联的数据都必须分到同一个shard中去。<br>我们稍微修改下之前的列子，叫county 成为branch 的父文档<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">PUT /company</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;country&quot;: &#123;&#125;,</div><div class="line">    &quot;branch&quot;: &#123;</div><div class="line">      &quot;_parent&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;country&quot; </div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;employee&quot;: &#123;</div><div class="line">      &quot;_parent&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;branch&quot; </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Countries and branches  只是简单的父子关系，所以我们用相同的方式来创建索引数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">POST /company/country/_bulk</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;uk&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;UK&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;france&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;France&quot; &#125;</div><div class="line"></div><div class="line">POST /company/branch/_bulk</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;london&quot;, &quot;parent&quot;: &quot;uk&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;London Westmintster&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;liverpool&quot;, &quot;parent&quot;: &quot;uk&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Liverpool Central&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;paris&quot;, &quot;parent&quot;: &quot;france&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Champs Élysées&quot; &#125;</div></pre></td></tr></table></figure></p>
<p>parent id 保证了每个branch和他们的父文档都被分配到了同一个shard中了，<br>如果和之前一样，我们来创建employee 数据，会发生什么？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">PUT /company/employee/1?parent=london</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;:  &quot;Alice Smith&quot;,</div><div class="line">  &quot;dob&quot;:   &quot;1970-10-24&quot;,</div><div class="line">  &quot;hobby&quot;: &quot;hiking&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>shard 会根据文档的parent ID—london 来分配employee 文档，但是这个london 文档会根据他的parent id uk来分配，所以employee文档和country、branch 很有可能被分配到不同的shard中。<br>所以我们需要一个额外的参数routing保证所有关联的文档被分配到同一个shard中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">PUT /company/employee/1?parent=london&amp;routing=uk </div><div class="line">&#123;</div><div class="line">  &quot;name&quot;:  &quot;Alice Smith&quot;,</div><div class="line">  &quot;dob&quot;:   &quot;1970-10-24&quot;,</div><div class="line">  &quot;hobby&quot;: &quot;hiking&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>parent 参数仍然用于子文档和父文档的关联，routing 参数是用于保证文档被分配到哪个shard中去<br>查询和聚合对于多级的文档也仍然有效，例如：问了找到哪些城市的员工喜欢hiking<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">GET /company/country/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;has_child&quot;: &#123;</div><div class="line">      &quot;type&quot;: &quot;branch&quot;,</div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;has_child&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;employee&quot;,</div><div class="line">          &quot;query&quot;: &#123;</div><div class="line">            &quot;match&quot;: &#123;</div><div class="line">              &quot;hobby&quot;: &quot;hiking&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/17/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/17/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-17T16:19:21+08:00">
                2017-08-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="John Doe" />
          <p class="site-author-name" itemprop="name">John Doe</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">
    Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    Theme &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Muse
    </a>
  </div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
